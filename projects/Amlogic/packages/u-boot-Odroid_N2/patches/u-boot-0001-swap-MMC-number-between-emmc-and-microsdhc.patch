From 10643b02e1c38662e6543b82c8ffe3e055cdca19 Mon Sep 17 00:00:00 2001
From: Dongjin Kim <tobetter@gmail.com>
Date: Fri, 25 Jan 2019 12:41:41 +0900
Subject: [PATCH] ODROID-C3/N2: swap MMC number between eMMC and uSD

Change-Id: I3032fca41ca4f20245b8cbf6e89316bf95e69edb
Signed-off-by: Dongjin Kim <tobetter@gmail.com>
---
 board/hardkernel/odroidc3/odroidc3.c | 16 ++++++++++++++--
 board/hardkernel/odroidn2/odroidn2.c | 24 +++++++++++++++---------
 include/configs/odroid-g12-common.h  |  4 ++--
 3 files changed, 31 insertions(+), 13 deletions(-)

diff --git a/board/hardkernel/odroidc3/odroidc3.c b/board/hardkernel/odroidc3/odroidc3.c
index 8aa6ee5ac6..fabf3f27c5 100644
--- a/board/hardkernel/odroidc3/odroidc3.c
+++ b/board/hardkernel/odroidc3/odroidc3.c
@@ -215,8 +215,8 @@ static void board_mmc_register(unsigned port)
 }
 int board_mmc_init(bd_t	*bis)
 {
-	board_mmc_register(SDIO_PORT_B);
-	board_mmc_register(SDIO_PORT_C);
+	board_mmc_register(SDIO_PORT_C);	// eMMC
+	board_mmc_register(SDIO_PORT_B);	// SD card
 
 	return 0;
 }
@@ -357,12 +357,24 @@ int board_init(void)
 	return 0;
 }
 
+#if !defined(CONFIG_FASTBOOT_FLASH_MMC_DEV)
+#define CONFIG_FASTBOOT_FLASH_MMC_DEV		0
+#endif
+
 #ifdef CONFIG_BOARD_LATE_INIT
 int board_late_init(void)
 {
 #if defined(CONFIG_FASTBOOT_FLASH_MMC_DEV)
 	/* select the default mmc device */
 	char buf[32];
+	int mmc_devnum = CONFIG_FASTBOOT_FLASH_MMC_DEV;
+
+	if (get_boot_device() == BOOT_DEVICE_EMMC)
+		mmc_devnum = 0;
+	else if (get_boot_device() == BOOT_DEVICE_SD)
+		mmc_devnum = 1;
+
+	/* select the default mmc device */
 	sprintf(buf, "mmc dev %d", CONFIG_FASTBOOT_FLASH_MMC_DEV);
 	run_command(buf, 0);
 #endif
diff --git a/board/hardkernel/odroidn2/odroidn2.c b/board/hardkernel/odroidn2/odroidn2.c
index 8f592a42cc..fb5ee8a903 100644
--- a/board/hardkernel/odroidn2/odroidn2.c
+++ b/board/hardkernel/odroidn2/odroidn2.c
@@ -212,8 +212,8 @@ static void board_mmc_register(unsigned port)
 }
 int board_mmc_init(bd_t	*bis)
 {
-	board_mmc_register(SDIO_PORT_B);
-	board_mmc_register(SDIO_PORT_C);
+	board_mmc_register(SDIO_PORT_C);	// eMMC
+	board_mmc_register(SDIO_PORT_B);	// SD card
 
 	return 0;
 }
@@ -377,6 +377,10 @@ int board_init(void)
 	return 0;
 }
 
+#if !defined(CONFIG_FASTBOOT_FLASH_MMC_DEV)
+#define CONFIG_FASTBOOT_FLASH_MMC_DEV		0
+#endif
+
 #ifdef CONFIG_BOARD_LATE_INIT
 int board_late_init(void)
 {
@@ -387,7 +391,15 @@ int board_late_init(void)
 #if defined(CONFIG_FASTBOOT_FLASH_MMC_DEV)
 	/* select the default mmc device */
 	char buf[32];
-	sprintf(buf, "mmc dev %d", CONFIG_FASTBOOT_FLASH_MMC_DEV);
+	int mmc_devnum = CONFIG_FASTBOOT_FLASH_MMC_DEV;
+
+	if (get_boot_device() == BOOT_DEVICE_EMMC)
+		mmc_devnum = 0;
+	else if (get_boot_device() == BOOT_DEVICE_SD)
+		mmc_devnum = 1;
+
+	/* select the default mmc device */
+	sprintf(buf, "mmc dev %d", mmc_devnum);
 	run_command(buf, 0);
 #endif
 
@@ -408,12 +420,6 @@ int board_late_init(void)
 		run_command("osd clear", 0);
 		run_command("vout output ${outputmode}", 0);
 		run_command("run booting_from_spi", 0);
-	} else if (get_boot_device() == BOOT_DEVICE_EMMC) {
-		// TODO:
-	} else if (get_boot_device() == BOOT_DEVICE_SD) {
-		// TODO:
-	} else {
-		printf("Unknown booting device!?\n");
 	}
 
 	return 0;
diff --git a/include/configs/odroid-g12-common.h b/include/configs/odroid-g12-common.h
index d3b73c8e6d..6d8fdd3607 100644
--- a/include/configs/odroid-g12-common.h
+++ b/include/configs/odroid-g12-common.h
@@ -91,7 +91,7 @@
 #define ENV_PXE_DEFAULT
 #endif
 
-#define ENV_MMC_LIST_DEFAULT			"mmc_list=1 0\0"
+#define ENV_MMC_LIST_DEFAULT			"mmc_list=0 1\0"
 
 #define ENV_MMC_DEFAULT					\
 	"boot_mmc="					\
@@ -398,7 +398,7 @@
 
 /* UBOOT fastboot config */
 #define CONFIG_CMD_FASTBOOT			1
-#define CONFIG_FASTBOOT_FLASH_MMC_DEV		1
+#define CONFIG_FASTBOOT_FLASH_MMC_DEV		0
 #define CONFIG_FASTBOOT_FLASH			1
 #define CONFIG_USB_GADGET			1
 #define CONFIG_USBDOWNLOAD_GADGET		1
